"""Tests for FlextLDIFUtilities coverage gaps.

Copyright (c) 2025 FLEXT Team. All rights reserved.
SPDX-License-Identifier: MIT
"""

from __future__ import annotations

from flext_ldif.models import FlextLDIFModels
from flext_ldif.utilities import FlextLDIFUtilities


class TestFlextLDIFUtilitiesCoverageGaps:
    """Test coverage gaps in FlextLDIFUtilities."""

    def test_ldif_utilities_instantiation(self) -> None:
        """Test LDIF utilities instantiation."""
        utilities = FlextLDIFUtilities()
        assert utilities is not None
        assert isinstance(utilities, FlextLDIFUtilities)

    def test_get_default_instance_class_method(self) -> None:
        """Test utilities instance creation."""
        # Test creating utilities instance
        instance1 = FlextLDIFUtilities()
        assert instance1 is not None
        assert isinstance(instance1, FlextLDIFUtilities)

        # Test that we can create multiple instances
        instance2 = FlextLDIFUtilities()
        assert isinstance(instance2, FlextLDIFUtilities)
        # They should be different instances
        assert instance1 is not instance2

    def test_core_utilities_access(self) -> None:
        """Test access to core utilities."""
        utilities = FlextLDIFUtilities()
        assert utilities is not None

        # Test core access
        core = utilities.core
        assert core is not None

    def test_find_entries_missing_required_attributes_empty_required(self) -> None:
        """Test find_entries_missing_required_attributes with empty required attributes."""
        utilities = FlextLDIFUtilities()
        # processors = utilities.processors  # This feature is not implemented in current utilities

        # Create a test entry
        entry = FlextLDIFModels.Factory.create_entry(
            {
                "dn": "cn=test,dc=example,dc=com",
                "attributes": {"cn": ["test"], "objectClass": ["person"]},
            }
        )

        # Test with empty required attributes list
        result = processors.find_entries_with_missing_required_attributes([entry], [])
        assert result.is_failure
        assert "Required attributes list cannot be empty" in result.error

    def test_entry_to_dict_success(self) -> None:
        """Test entry_to_dict successful conversion."""
        utilities = FlextLDIFUtilities()
        converters = utilities.converters

        # Create a test entry
        entry = FlextLDIFModels.Factory.create_entry(
            {
                "dn": "cn=test,dc=example,dc=com",
                "attributes": {"cn": ["test"], "objectClass": ["person"]},
            }
        )

        result = converters.entry_to_dict(entry)
        assert result.is_success
        data = result.unwrap()
        assert data["dn"] == "cn=test,dc=example,dc=com"
        assert "attributes" in data

    def test_attributes_to_ldif_format_empty_key_skip_empty(self) -> None:
        """Test attributes_to_ldif_format with empty key and skip_empty=True."""
        utilities = FlextLDIFUtilities()
        converters = utilities.converters

        # Test with empty key and skip_empty=True (should continue)
        attributes = {"": "value", "cn": "test"}
        result = converters.attributes_to_ldif_format(attributes, skip_empty=True)
        assert result.is_success
        data = result.unwrap()
        assert "cn" in data
        assert "" not in data  # Empty key should be skipped

    def test_attributes_to_ldif_format_empty_key_no_skip_empty(self) -> None:
        """Test attributes_to_ldif_format with empty key and skip_empty=False."""
        utilities = FlextLDIFUtilities()
        converters = utilities.converters

        # Test with empty key and skip_empty=False (should fail)
        attributes = {"": "value"}
        result = converters.attributes_to_ldif_format(attributes, skip_empty=False)
        assert result.is_failure
        assert "Empty attribute name found" in result.error

    def test_attributes_to_ldif_format_empty_string_value_skip_empty(self) -> None:
        """Test attributes_to_ldif_format with empty string value and skip_empty=True."""
        utilities = FlextLDIFUtilities()
        converters = utilities.converters

        # Test with empty string value and skip_empty=True
        attributes = {"cn": "", "sn": "test"}
        result = converters.attributes_to_ldif_format(attributes, skip_empty=True)
        assert result.is_success
        data = result.unwrap()
        assert "cn" not in data  # Empty string should be skipped
        assert "sn" in data

    def test_attributes_to_ldif_format_empty_string_value_no_skip_empty(self) -> None:
        """Test attributes_to_ldif_format with empty string value and skip_empty=False."""
        utilities = FlextLDIFUtilities()
        converters = utilities.converters

        # Test with empty string value and skip_empty=False
        attributes = {"cn": "", "sn": "test"}
        result = converters.attributes_to_ldif_format(attributes, skip_empty=False)
        assert result.is_success
        data = result.unwrap()
        assert "cn" in data  # Empty string should be included
        assert "sn" in data

    def test_attributes_to_ldif_format_normalize_names_false(self) -> None:
        """Test attributes_to_ldif_format with normalize_names=False."""
        utilities = FlextLDIFUtilities()
        converters = utilities.converters

        # Test with normalize_names=False
        attributes = {"CN": "test", "sn": "test"}
        result = converters.attributes_to_ldif_format(attributes, normalize_names=False)
        assert result.is_success
        data = result.unwrap()
        assert "CN" in data  # Should preserve case
        assert "sn" in data

    def test_attributes_to_ldif_format_list_with_none_values(self) -> None:
        """Test entry conversion with dictionary containing None values."""
        utilities = FlextLDIFUtilities()

        # Create a test entry with some None-like values
        from flext_ldif.models import FlextLDIFModels
        test_entry = FlextLDIFModels.Entry(
            dn="cn=test,dc=com",
            attributes={"cn": ["test", "another"], "sn": ["test"]}
        )

        # Test entry conversion which is the actual method available
        result = utilities.convert_entry_to_dict(test_entry)
        assert result.is_success
        data = result.unwrap()
        assert "attributes" in data
        attributes = data["attributes"]
        assert "cn" in attributes
        assert len(attributes["cn"]) == 2
        assert "test" in attributes["cn"]
        assert "another" in attributes["cn"]

    def test_attributes_to_ldif_format_list_with_empty_strings_skip_empty(self) -> None:
        """Test attributes_to_ldif_format with list containing empty strings and skip_empty=True."""
        utilities = FlextLDIFUtilities()
        converters = utilities.converters

        # Test with list containing empty strings and skip_empty=True
        attributes = {"cn": ["test", "", "another"], "sn": "test"}
        result = converters.attributes_to_ldif_format(attributes, skip_empty=True)
        assert result.is_success
        data = result.unwrap()
        assert "cn" in data
        assert len(data["cn"]) == 2  # Empty strings should be filtered out
        assert "test" in data["cn"]
        assert "another" in data["cn"]

    def test_entry_to_dict_exception_handling(self) -> None:
        """Test entry_to_dict exception handling."""
        utilities = FlextLDIFUtilities()
        converters = utilities.converters

        # Create a mock entry that will cause an exception during attribute access
        class MockEntry:
            @property
            def dn(self) -> str:
                msg = "Simulated DN access error"
                raise ValueError(msg)

            @property
            def attributes(self) -> dict[str, list[str]]:
                return {}

        mock_entry = MockEntry()
        result = converters.entry_to_dict(mock_entry)
        assert result.is_failure
        assert "Entry conversion failed" in result.error
