"""Tests for LDIF exceptions - comprehensive coverage.

Copyright (c) 2025 FLEXT Team. All rights reserved.
SPDX-License-Identifier: MIT
"""

from __future__ import annotations

import pytest

from flext_ldif.exceptions import (
    FlextLDIFAuthenticationError,
    FlextLDIFConnectionError,
    FlextLDIFError,
    FlextLDIFErrorCodes,
    FlextLDIFFileError,
    FlextLDIFParseError,
    FlextLDIFProcessingError,
    FlextLDIFTimeoutError,
    FlextLDIFValidationError,
)


class TestFlextLDIFExceptions:
    """Test suite for FLEXT LDIF exceptions."""

    def test_flext_ldif_error_default(self) -> None:
        """Test FlextLDIFError with default parameters."""
        error = FlextLDIFError("Default error message")
        assert isinstance(error, Exception)
        assert isinstance(error, FlextLDIFError)

    def test_flext_ldif_error_custom_message(self) -> None:
        """Test FlextLDIFError with custom message."""
        error = FlextLDIFError("Custom LDIF error")
        assert "Custom LDIF error" in str(error)

    def test_flext_ldif_parse_error_inheritance(self) -> None:
        """Test FlextLDIFParseError inheritance."""
        error = FlextLDIFParseError("Parse error")
        assert isinstance(error, FlextLDIFError)
        assert isinstance(error, FlextLDIFParseError)
        assert "Parse error" in str(error)

    def test_flext_ldif_validation_error_inheritance(self) -> None:
        """Test FlextLDIFValidationError inheritance."""
        error = FlextLDIFValidationError("Validation error")
        assert isinstance(error, FlextLDIFValidationError)
        assert isinstance(error, Exception)  # Both inherit from Exception
        assert "Validation error" in str(error)

    def test_flext_ldif_entry_error_inheritance(self) -> None:
        """Test FlextLDIFError inheritance."""
        error = FlextLDIFError("Entry error")
        assert isinstance(error, FlextLDIFError)
        assert "Entry error" in str(error)

    def test_exception_hierarchy(self) -> None:
        """Test exception hierarchy is correct."""
        # Test that all exceptions inherit from FlextLDIFError
        parse_error = FlextLDIFParseError("test")
        validation_error = FlextLDIFValidationError("test")
        entry_error = FlextLDIFError("test")

        assert isinstance(parse_error, FlextLDIFError)
        assert isinstance(validation_error, FlextLDIFError)
        assert isinstance(entry_error, FlextLDIFError)

    def test_exception_can_be_raised_and_caught(self) -> None:
        """Test exceptions can be raised and caught properly."""
        test_error_msg = "test error"
        parse_error_msg = "parse error"
        validation_error_msg = "validation error"
        entry_error_msg = "entry error"

        with pytest.raises(FlextLDIFError):
            raise FlextLDIFError(test_error_msg)

        with pytest.raises(FlextLDIFParseError):
            raise FlextLDIFParseError(parse_error_msg)

        with pytest.raises(FlextLDIFValidationError):
            raise FlextLDIFValidationError(validation_error_msg)

        with pytest.raises(FlextLDIFError):
            raise FlextLDIFError(entry_error_msg)

    def test_exception_messages(self) -> None:
        """Test exception messages are preserved and include error codes."""
        message = "Custom error message"

        error = FlextLDIFError(message)
        assert message in str(error)  # Message should be in the string representation

        parse_error = FlextLDIFParseError(message)
        assert message in str(parse_error)

        validation_error = FlextLDIFValidationError(message)
        assert message in str(validation_error)

        entry_error = FlextLDIFError(message)
        assert message in str(entry_error)

    def test_error_codes_enum(self) -> None:
        """Test that error codes enum contains expected values."""
        expected_codes = [
            "PARSE_ERROR",
            "VALIDATION_ERROR",
            "PROCESSING_ERROR",
            "FILE_ERROR",
            "CONFIGURATION_ERROR",
            "CONNECTION_ERROR",
            "TIMEOUT_ERROR",
            "AUTHENTICATION_ERROR",
        ]

        for code in expected_codes:
            assert hasattr(FlextLDIFErrorCodes, code)
            assert getattr(FlextLDIFErrorCodes, code).value == code

    def test_all_exception_classes(self) -> None:
        """Test all exception classes can be instantiated and inherit correctly."""
        # Test configuration error
        config_error = FlextLDIFError("Config error")
        assert isinstance(config_error, FlextLDIFError)
        assert "Config error" in str(config_error)

        # Test processing error
        processing_error = FlextLDIFProcessingError("Processing error")
        assert isinstance(processing_error, FlextLDIFError)
        assert "Processing error" in str(processing_error)

        # Test connection error
        connection_error = FlextLDIFConnectionError("Connection error")
        assert isinstance(connection_error, FlextLDIFError)
        assert "Connection error" in str(connection_error)

        # Test authentication error
        auth_error = FlextLDIFAuthenticationError("Auth error")
        assert isinstance(auth_error, FlextLDIFError)
        assert "Auth error" in str(auth_error)

        # Test timeout error
        timeout_error = FlextLDIFTimeoutError("Timeout error")
        assert isinstance(timeout_error, FlextLDIFError)
        assert "Timeout error" in str(timeout_error)

        # Test file error
        file_error = FlextLDIFFileError("File error")
        assert isinstance(file_error, FlextLDIFError)
        assert "File error" in str(file_error)

        # Test entry validation error
        entry_validation_error = FlextLDIFValidationError("Entry validation error")
        assert isinstance(entry_validation_error, FlextLDIFValidationError)
        assert "Entry validation error" in str(entry_validation_error)

    def test_exception_with_context(self) -> None:
        """Test exceptions with context parameter."""
        context = {"file": "test.ldif", "line": 42}
        error = FlextLDIFError("Error with context", context=context)
        # Context should be preserved in the exception
        assert hasattr(error, "context") or str(
            error
        )  # Either attribute exists or context is in string

    def test_exception_with_cause(self) -> None:
        """Test exceptions with context containing cause information."""
        cause = ValueError("Original error")
        error = FlextLDIFError("LDIF error", context={"cause": str(cause)})
        # Context should contain cause information
        assert error.context is not None
        assert "context" in error.context
        assert "cause" in error.context["context"]
        assert "Original error" in str(error.context["context"]["cause"])

    def test_file_error_with_file_path(self) -> None:
        """Test FlextLDIFFileError with file_path parameter."""
        file_path = "/path/to/test.ldif"
        error = FlextLDIFFileError("File not found", context={"file_path": file_path})
        assert "File not found" in str(error)

    def test_entry_validation_error_with_params(self) -> None:
        """Test FlextLDIFValidationError with additional parameters."""
        error = FlextLDIFValidationError("Validation failed")
        assert "Validation failed" in str(error)

    def test_file_error_with_all_context_parameters(self) -> None:
        """Test FlextLDIFFileError with all context parameters to cover missing lines."""
        error = FlextLDIFFileError(
            "File operation failed",
            context={
                "file_path": "/path/to/test.ldif",
                "line_number": 42,
                "operation": "read",
                "encoding": "utf-8",
            },
        )
        assert "File operation failed" in str(error)

    def test_entry_validation_error_with_long_attribute_value(self) -> None:
        """Test FlextLDIFValidationError with long attribute value."""
        error = FlextLDIFValidationError("Attribute too long")
        assert "Attribute too long" in str(error)

    def test_entry_validation_error_with_short_attribute_value(self) -> None:
        """Test FlextLDIFValidationError with short attribute value."""
        error = FlextLDIFValidationError("Attribute validation failed")
        assert "Attribute validation failed" in str(error)
